## Level Protcol Contracts

The Level Protocol is structured around the ERC-20 `lvlUSD` stablecoin and its staked counterpart `slvlUSD`. `LevelMinting` allows institutional participants to mint `lvlUSD` by collateralizing stablecoins like USDC and USDT and to redeem collateral by burning `lvlUSD`. `StakedlvlUSD` allows users to stake their `lvlUSD` to gain exposure to long-tailed basis trade positions and to earn yield -- this exposure is tokenized by `slvlUSD`. `Freezer` enables a first-loss protection mechanism by which stakers take on risk to protect the value of `lvlUSD`: while `slvlUSD` may accrue yield, it may also lose a portion of its value when `lvlUSD` held by the staking contract is frozen to preserve the value of `lvlUSD`. `Slasher` is responsible for burning `lvlUSD`.

## lvlUSD

`lvlUSD` is an ERC20 stablecoin token that supports denylisting, minting, and burning. Denylisted addresses are not allowed to transfer or receive `lvlUSD`.
The admin can designate up to one _minter_ and _slasher_. These designations can be revoked and changed at any time. The minter is allowed to mint `lvlUSD` to a non-denylisted receiver address,
while the slasher is responsible for burning `lvlUSD` withdrawn from the freezer. The significance of the `slasher` address is that it is allowed to withdraw funds from freezers for burning. When checking for whether a caller has permission to withdraw `lvlUSD`, freezers will query the `lvlUSD` for the _slasher_ address. Funds withdrawn from the freezer to the slasher are slated to be burned, while funds withdrawn from the freezer back to `StakedlvlUSD` re-enter circulation through a vesting process.

### Roles

| Role             | Description                                                                                                                                                                                                                    | Operators                                                            | # of Roles | Type     |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------- | ---------- | -------- |
| Admin            | The admin of the contract can set the minter contract, the slasher contract, and denylister EOAs                                                                                                                               | Level Foundation                                                     | 1          | Multisig |
| Denylist Manager | The denylist manager can add arbitrary EOAs to a denylist, which prevents the address from transferring, minting, or redeeming lvlUSD. This is similar to Tether and Circle’s denylist, and intended to be used a similar way. | Level Foundation                                                     | N < 5      | Multisig |
| Minting Contract | See LevelMinting                                                                                                                                                                                                               | Smart contract whose admin address is controlled by Level Foundation | 1          | Contract |

### Functions

| Functionality                         | Description                                                                                               | Access Control   | # of Roles | Type     |
| ------------------------------------- | --------------------------------------------------------------------------------------------------------- | ---------------- | ---------- | -------- |
| mint()                                | Adds to lvlUSD supply. Can only be called by a single address (the minting contract).                     | Minting Contract | 1          | Multisig |
| burn()                                | Decrement’s the caller’s balance to remove lvlUSD from the total supply.                                  | Anyone           | N < 5      | Multisig |
| transfer() / transferFrom()           | Transfers lvlUSD from one address to another. This transaction will fail for denylisted addresses         | Anyone           | 1          | Contract |
| setMinter()                           | Lets the admin designate the single LevelMinting contract that all mints and redemptions will go through. | Admin            |            |          |
| addToDenylist()/ removeFromDenylist() | Lets the admin denylist an address, preventing it from minting, burning, or transferring any lvlUSD.      | Denylist Manager |            |          |

## LevelMinting

`LevelMinting` is a clone of of Ethena protocol's `EthenaMinting` [contract](https://github.com/ethena-labs/code4arena-contest/blob/main/protocols/USDe/contracts/EthenaMinting.sol). It controls the supply of `lvlUSD` in circulation by allowing approved minters and redeemers to mint `lvlUSD` by depositing collateral assets (e.g. USDC, USDT) and redeem assets by burning `lvlUSD`.

### Roles

| Role       | Description                                                                                                                                                                                 | Operators                                           | # of Roles | Type     |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------- | ---------- | -------- |
| Admin      | The admin of the contract can: set minters, redeemers, and gatekeepers, add/remove authorized collateral, and add/remove authorized reserve addresses.                                      | Level Foundation                                    | 1          | Multisig |
| Minter     | Minters are authorized addresses that can call mint() on the LevelMinting contract.                                                                                                         | Level Foundation                                    | N < 20     | EOA      |
| Redeemer   | Redeemers are authorized addresses that can call redeem() on the LevelMinting contract                                                                                                      | Level Foundation                                    | N < 20     | EOA      |
| Gatekeeper | Gatekeepers guard the protocol from unauthorized mints and redemptions. Gatekeeper addresses can stop all issuance, as well as remove the minter and redeemer role from specific addresses. | Level Foundation and 3rd party security contractors | N          | EOA      |

## Functions

| Functionality                                  | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Access Control |
| ---------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- |
| mint()                                         | This function atomically swaps a supportedAsset from a KYC/KYB’ed benefactor address to lvlUSD that’s sent to a KYC/KYB’ed beneficiary address. The conversion rate is passed in as an argument to the function. This function can only be called by an address with the minter permission, and will usually only be called by an offchain server controlled by the foundation. The offchain server will maintain a record of valid benefactors and beneficiaries. One argument to the mint function is a cryptographic signature from the benefactor. Mints containing invalid signatures (which cryptographically sign order details, including the amounts of supportedAsset and lvlUSD to transfer as well as any expiry dates) will fail. This prevents the protocol from unilaterally taking funds from the benefactor. The contract can also define a max. mint amount per unit of time. Mints that exceed that amount will fail. This is to limit the impact of compromised keys.                                                                                                                                                                                                                                                                      | Minter         |
| redeem()                                       | This function atomically swaps lvlUSD from a KYC/KYB’ed benefactor address to a supportedAsset that’s sent to a KYC/KYB’ed beneficiary address. The conversion rate is passed in as an argument to the function. The lvlUSD that is sent to be redeemed is burned. This function can only be called by an address with the minter permission, and will usually only be called by an offchain server controlled by the foundation. The offchain server will maintain a record of valid benefactors and beneficiaries. One argument to the redeem function is a cryptographic signature from the benefactor. Mints containing invalid signatures (which cryptographically sign order details, including the amounts of supportedAsset and lvlUSD to transfer as well as any expiry dates) will fail. This prevents the protocol from unilaterally taking lvlUSD from the benefactor. The contract can also define a max. redeem amount per unit of time. Redemptions that exceed that amount will fail. This is to limit the impact of compromised keys. To support redemptions, the LevelMinting contract will need to hold collateral assets, likely other stablecoins. These stablecoins will be provided from the reserve accounts held by Level Foundation. | Redeemer       |
| transferToReserve()                            | Transfers supportedAssets to the Foundation’s reserve accounts at Copper, Ceffu, and others. This function can only be called by an address with the minter permission, and will usually only be called by an offchain server controlled by the foundation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Minter         |
| setMaxMintPerBlock() / setMaxRedeemPerBlock()  | Defines the max amount of lvlUSD that can be minted or redeemed per block. Can be thought of as a rate limiter that minimizes the impact of malicious addresses.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Admin          |
| setDelegatedSigner() / removeDelegatedSigner() | Allows KYC/KYB’ed minters and redeemers to delegate an authorized signer to sign signatures passed to mint() and redeem() on their behalf. This is mostly intended to be used by KYC/B’ed minters and redeemers whose primary address is a multisig.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Anyone         |
| disableMintRedeem()                            | Sets the max amount of lvlUSD that can be minted or redeemed to 0, disabling mints and redemptions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Gatekeeper     |
| addSupportedAsset() / removeSupportedAsset()   | Adds assets that can be used to mint or redeem lvlUSD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Admin          |
| addReserveAddress() / removeReserveAddress()   | Adds valid reserve addresses that collateral can be transferred to/from                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Admin          |
| removeMinterRole() / removeRedeemerRole()      | Removes the minter/redeemer role from addresses, intended to secure the protocol against compromised keys/addresses.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Gatekeepers    |

## Staked Level USD

`Staked Level USD` lets users stake Level USD for basis yield; it is based on Ethena's sUSDe staking contract, but has several distinct mechanisms, notably a freezing and slashing mechanism. It is also sometimes called the `Level Vault Contract` or `Tokenized Trade Contract`

`Staked Level USD` follows the ERC-20 and [ERC4626](https://ethereum.org/en/developers/docs/standards/tokens/erc-4626/) standards, so it functions as both a token (`slvlUSD`) and a vault. Importantly, `StakedlvlUSD` allows users to deposit `lvlUSD` and receive shares, namely staked lvlUSD `slvlUSD`. Shares represent a stake in the`lvlUSD` owned by this contract, which fluctuates in amount depending on the inflow of `lvlUSD` rewards and potential freezing events.

Yield is generated off-chain through a basis trade, and dedicated rewarders transfer rewards in the form of `lvlUSD` into the staking contract every eight hours. The `lvlUSD` rewards vest over the course of 8 hours to prevent frontrunning and backrunning attacks. Rewards increase the amount of `lvlUSD` in the staking contract and therefore the value of `slvlUSD` shares.

Users initiate the unstaking process (redeeming `lvlUSD` by burning `slvlUSD`) by calling `cooldownShares` or `cooldownAssets`, which transfers their `slvlUSD` to a silo, where it is kept until the cooldown period ends. By default, the cooldown period is set to 7 days. At the end of the cooldown period, users call `unstake` to burn `slvlUSD` and redeem `lvlUSD`.

**Key Changes**
Level differs from Ethena in that the calculation of how much `lvlUSD` a user can redeem for a fixed amount of `slvlUSD` is done when the `unstake` function is called, and not when `cooldownShares` or `cooldownAssets` are called. This is necessary because in the Level protocol,`lvlUSD` held by the staking contract can be frozen (and taken out of circulation) at any time to ensure first-loss protection. If `lvlUSD` is frozen, one unit of `slvlUSD` will be worth relatively less `lvlUSD`. On the other hand, when `lvlUSD` is deposited into the contract by the rewarder, `slvlUSD` appreciates in value. It is also possible for frozen funds to re-enter circulation, but more on that below.

There will be a separate deployments of `Staked Level USD` for each long-tailed basis trade (SOL, BTC, etc.) that Level Protocol will offer exposure to.

### Roles

| Role               | Description                                                                                                                                                                                                                                                                                                                                                                                                                                       | Operators                                                                                                                   | # of Roles | Type     |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- | ---------- | -------- |
| Admin              | The admin can assign roles such as denylist manager, rewarder, and freezer roles. Admin can also control configuration variables like the cooldown period between initiating and completing withdrawals. Finally the admin can redistribute shares from denylisted addresses, and rescue any ERC-20 tokens that were unintentionally sent to the contract.                                                                                        | Level Foundation                                                                                                            | 1          | Multisig |
| Denylist Manager   | The denylist manager can add arbitrary EOAs to a denylist, which prevents the address from transferring, minting, or redeeming vault shares. This is similar to Tether and Circle’s denylist, and intended to be used a similar way. Unlike the lvlUSD denylist, there are two separate denylists. The soft denylist prevents addresses from staking, while the full denylist prevents addresses from staking, unstaking, or transferring shares. | Level Foundation                                                                                                            | N < 5      | Multisig |
| Rewarder           | Rewarders can deposit yield from reserves into vaults without creating new shares.                                                                                                                                                                                                                                                                                                                                                                | Level Foundation                                                                                                            | N < 5      | Multisig |
| Freezer (role)     | Freezers can transfer lvlUSD from the vault to a Freezer contract.                                                                                                                                                                                                                                                                                                                                                                                | Level Foundation                                                                                                            | 1          | Multisig |
| Freezer (contract) | The freezer contract stores frozen lvlUSD. Freezer roles can withdraw lvlUSD from the freezer contract back to the vault.                                                                                                                                                                                                                                                                                                                         | Immutable smart contract; addresses that can move funds from and to the freezer contract are controlled by Level Foundation | 1          | Contract |
| Silo               | The silo escrows shares for a user who has initiated a withdrawal. Only the underlying vault can move shares to and from the silo.                                                                                                                                                                                                                                                                                                                | Immutable smart contract with no external roles                                                                             | 1          | Contract |

### Functions

| Functionality                         | Description                                                                                                                                                                                                                                                                                                                                   | Access Control | Multisig |
| ------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- | -------- |
| deposit()                             | The user will send lvlUSD into the vault and mint shares of the vault.                                                                                                                                                                                                                                                                        | Anyone         | Multisig |
| cooldownShares() / cooldownAssets()   | Initiates the cooldown period. The vault will transfer the caller’s shares to the silo contract where it will be escrowed during the cooldown period. If a user has an existing withdrawal request, any new withdrawal request will restart the cooldown period.                                                                              | Anyone         | Contract |
| unstake()                             | Completes the unstaking process. The vault will transfer the caller’s shares back to the caller, calculate the amount of lvlUSD to transfer back to the caller, and simultaneously burn the shares and transfer the user’s stake.                                                                                                             | Anyone         | Contract |
| freeze()                              | Transfers lvlUSD in the vault to the Freezer contract, preventing that amount from being withdrawn. This process does not affect the number of shares outstanding.                                                                                                                                                                            | Freezer        |          |
| transferInFrozenFunds()               | Transfers lvlUSD in the Freezer contract back to the vault. Unfrozen lvlUSD vests over an 8 hour period, which prevents sandwich attacks from happening. This process does not affect the number of shares outstanding.                                                                                                                       | Freezer        |          |
| transferInRewards()                   | Transfers lvlUSD from the protocol’s reserves into the vault. Rewards also vest over an 8 hour period to prevent sandwich attacks. This does not affect the number of shares outstanding.                                                                                                                                                     | Rewar          |          |
| addToDenylist()/ removeFromDenylist() | Lets the admin denylist an address. If the address is added to the soft denylist, they can do everything but stake new lvlUSD; if address is added to the hard denylist, the address will not be able to stake, unstake, or transfer shares. Addresses that are hard denylisted will likely have their shares redistributed to a new address. | Admin          |          |

## slvlUSDSilo

`slvlUSDSilo` stores `slvlUSD` during the unstaking cooldown period.

## Freezer

To enable first-loss protection, `StakedlvlUSD` allows `lvlUSD` to be frozen (withdrawn to a freezer contract and temporarily made unavailable for users to redeem) in the event that the basis trade position backing the value of `lvlUSD` declines in value -- this reduces the supply of `lvlUSD` in circulation and ensures that its value remains pegged to the dollar. This does not offer absolute protection, but rather offers protection up to the dollar value of staked `lvlUSD`- it is primarily intended to cover black swan events such as reserve/exchange failures that may result in a rapid undercollateralization of the reserves. Frozen `lvlUSD` will eventually be withdrawn back to the staking contract if the the basis trade position recovers in value or withdrawn to the slasher to be burned and permanently taken out of circulation.

## Slasher

The slasher contract is responsible for burning `lvlUSD`. It is managed by a single admin and can withdraw `lvlUSD` both from and to the freezer contract.
