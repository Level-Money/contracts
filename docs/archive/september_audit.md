## Level Protcol Contracts

The Level Protocol is structured around the ERC-20 `lvlUSD` stablecoin and its staked counterpart `slvlUSD`. `LevelMinting` allows institutional participants to mint `lvlUSD` by collateralizing stablecoins like USDC and USDT and to redeem collateral by burning `lvlUSD`. `StakedlvlUSD` allows users to stake their `lvlUSD` to gain exposure to long-tailed basis trade positions and to earn yield -- this exposure is tokenized by `slvlUSD`. `Freezer` enables a first-loss protection mechanism by which stakers take on risk to protect the value of `lvlUSD`: while `slvlUSD` may accrue yield, it may also lose a portion of its value when `lvlUSD` held by the staking contract is frozen to preserve the value of `lvlUSD`. `Slasher` is responsible for burning `lvlUSD`.

## lvlUSD

`lvlUSD` is an ERC20 stablecoin token that supports denylisting, minting, and burning. Denylisted addresses are not allowed to transfer or receive `lvlUSD`.
The admin can designate up to one _minter_. This designation can be revoked and changed at any time. The minter is allowed to mint `lvlUSD` to a non-denylisted receiver address.

### Roles

| Role             | Description                                                                                                                                                                                                                    | Operators                                                            | # of Roles | Type     |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------- | ---------- | -------- |
| Admin            | The admin of the contract can set the minter contract, the slasher contract, and denylister EOAs                                                                                                                               | Level Foundation                                                     | 1          | Multisig |
| Denylist Manager | The denylist manager can add arbitrary EOAs to a denylist, which prevents the address from transferring, minting, or redeeming lvlUSD. This is similar to Tether and Circle’s denylist, and intended to be used a similar way. | Level Foundation                                                     | N < 5      | Multisig |
| Minting Contract | See LevelMinting                                                                                                                                                                                                               | Smart contract whose admin address is controlled by Level Foundation | 1          | Contract |

### Functions

| Functionality                         | Description                                                                                               | Access Control   | # of Roles | Type     |
| ------------------------------------- | --------------------------------------------------------------------------------------------------------- | ---------------- | ---------- | -------- |
| mint()                                | Adds to lvlUSD supply. Can only be called by a single address (the minting contract).                     | Minting Contract | 1          | Multisig |
| burn()                                | Decrement’s the caller’s balance to remove lvlUSD from the total supply.                                  | Anyone           | N < 5      | Multisig |
| transfer() / transferFrom()           | Transfers lvlUSD from one address to another. This transaction will fail for denylisted addresses         | Anyone           | 1          | Contract |
| setMinter()                           | Lets the admin designate the single LevelMinting contract that all mints and redemptions will go through. | Admin            |            |          |
| addToDenylist()/ removeFromDenylist() | Lets the admin denylist an address, preventing it from minting, burning, or transferring any lvlUSD.      | Denylist Manager |            |          |

## LevelMinting

`LevelMinting` is inspired by and built on top of Ethena protocol's `EthenaMinting` [contract](https://github.com/ethena-labs/code4arena-contest/blob/main/protocols/USDe/contracts/EthenaMinting.sol). It controls the supply of `lvlUSD` in circulation by allowing approved minters and redeemers to mint `lvlUSD` by depositing collateral assets (e.g. USDC, USDT) and redeem assets by burning `lvlUSD` in a 1:1 ratio. Redemptions are done in a two-step process when cooldowns are enabled -- by default users have to wait 7 days to redeem their collateral.

### Roles

| Role       | Description                                                                                                                                                                                 | Operators                                           | # of Roles | Type     |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------- | ---------- | -------- |
| Admin      | The admin of the contract can: set minters, redeemers, and gatekeepers, add/remove authorized collateral, and add/remove authorized reserve addresses.                                      | Level Foundation                                    | 1          | Multisig |
| Minter     | Minters are authorized addresses that can call mint() on the LevelMinting contract.                                                                                                         | Level Foundation                                    | N < 20     | EOA      |
| Redeemer   | Redeemers are authorized addresses that can call redeem() on the LevelMinting contract                                                                                                      | Level Foundation                                    | N < 20     | EOA      |
| Gatekeeper | Gatekeepers guard the protocol from unauthorized mints and redemptions. Gatekeeper addresses can stop all issuance, as well as remove the minter and redeemer role from specific addresses. | Level Foundation and 3rd party security contractors | N          | EOA      |

## Functions

| Functionality                                 | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Access Control |
| --------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- |
| mint()                                        | This function atomically swaps a supported stablecoin from a benefactor address to lvlUSD that’s sent to a beneficiary address. The conversion rate is assumed to be one-to-one. This function can only be called by an address with the minter permission. The contract can also define a max. mint amount per unit of time. Mints that exceed that amount will fail.                                                                                                                                                                                                                                                                                                              | Minter         |
| redeem()                                      | This function can only be called when cooldown for redemptions is turned off. It atomically and immediately swaps lvlUSD from a benefactor address to a supportedAsset that’s sent to a beneficiary address. The conversion rate is assumed to be one-to-one. The lvlUSD that is sent to be redeemed is burned. This function can only be called by an address with the redeemer permission. The contract can also define a max. redeem amount per unit of time. Redemptions that exceed that amount will fail. To support redemptions, the LevelMinting contract will need to hold collateral assets, namely other stablecoins. These reserves are managed by LevelReserveManager. | Redeemer       |
| initiateRedeem()                              | This function can only be called when cooldowns for redemptions are enabled (`cooldownDuration` > 0). It initiates the redemption process by storing the user's order request in contract storage and by starting a timer, after which the request may be fulfilled via `completeRedeem`. Other aspects of this function are the same as `redeem`. By default, the cooldown period is set to be 7 days. This gives LevelReserveManager time to unstake collateral and transfer them back to LevelMinting so that redemptions from users can be fulfilled.                                                                                                                           | Redeemer       |
| completeRedeem()                              | This function can only be called when cooldowns for redemptions are enabled (`cooldownDuration` > 0). This functions calls the internal `_redeem` function to fulfill a user's redemption request, and should be called after the user waits for `cooldownDuration` after calling `initiateRedeem`.                                                                                                                                                                                                                                                                                                                                                                                 | Redeemer       |
| transferToReserve()                           | Transfers supportedAssets to the LevelReserveManager. This function can only be called by an address with the admin permission.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Minter         |
| setMaxMintPerBlock() / setMaxRedeemPerBlock() | Defines the max amount of lvlUSD that can be minted or redeemed per block. Can be thought of as a rate limiter that minimizes the impact of malicious addresses.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Admin          |
| disableMintRedeem()                           | Sets the max amount of lvlUSD that can be minted or redeemed to 0, disabling mints and redemptions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Gatekeeper     |
| addSupportedAsset() / removeSupportedAsset()  | Adds assets that can be used to mint or redeem lvlUSD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Admin          |
| addReserveAddress() / removeReserveAddress()  | Adds valid reserve addresses that collateral can be transferred to/from                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Admin          |
| removeMinterRole() / removeRedeemerRole()     | Removes the minter/redeemer role from addresses, intended to secure the protocol against compromised keys/addresses.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Gatekeepers    |

## Staked Level USD

`Staked Level USD` lets users stake Level USD for basis yield; it is based on Ethena's sUSDe staking contract, but has several distinct mechanisms, notably a freezing and slashing mechanism. It is also sometimes called the `Level Vault Contract` or `Tokenized Trade Contract`

`Staked Level USD` follows the ERC-20 and [ERC4626](https://ethereum.org/en/developers/docs/standards/tokens/erc-4626/) standards, so it functions as both a token (`slvlUSD`) and a vault. Importantly, `StakedlvlUSD` allows users to deposit `lvlUSD` and receive shares, namely staked lvlUSD `slvlUSD`. Shares represent a stake in the`lvlUSD` owned by this contract, which fluctuates in amount depending on the inflow of `lvlUSD` rewards and potential freezing events.

Yield is generated off-chain through a basis trade, and dedicated rewarders transfer rewards in the form of `lvlUSD` into the staking contract every eight hours. The `lvlUSD` rewards vest over the course of 8 hours to prevent frontrunning and backrunning attacks. Rewards increase the amount of `lvlUSD` in the staking contract and therefore the value of `slvlUSD` shares.

Users initiate the unstaking process (redeeming `lvlUSD` by burning `slvlUSD`) by calling `cooldownShares` or `cooldownAssets`, which transfers their `slvlUSD` to a silo, where it is kept until the cooldown period ends. By default, the cooldown period is set to 7 days. At the end of the cooldown period, users call `unstake` to burn `slvlUSD` and redeem `lvlUSD`.

**Key Changes**
Level differs from Ethena in that the calculation of how much `lvlUSD` a user can redeem for a fixed amount of `slvlUSD` is done when the `unstake` function is called, and not when `cooldownShares` or `cooldownAssets` are called. This is necessary because in the Level protocol,`lvlUSD` held by the staking contract can be frozen (and taken out of circulation) at any time to ensure first-loss protection. If `lvlUSD` is frozen, one unit of `slvlUSD` will be worth relatively less `lvlUSD`. On the other hand, when `lvlUSD` is deposited into the contract by the rewarder, `slvlUSD` appreciates in value. It is also possible for frozen funds to re-enter circulation, but more on that below.

There will be a separate deployments of `Staked Level USD` for each long-tailed basis trade (SOL, BTC, etc.) that Level Protocol will offer exposure to.

### Roles

| Role               | Description                                                                                                                                                                                                                                                                                                                                                                                                                                       | Operators                                                                                                                   | # of Roles | Type     |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- | ---------- | -------- |
| Admin              | The admin can assign roles such as denylist manager, rewarder, and freezer roles. Admin can also control configuration variables like the cooldown period between initiating and completing withdrawals. Finally the admin can redistribute shares from denylisted addresses, and rescue any ERC-20 tokens that were unintentionally sent to the contract.                                                                                        | Level Foundation                                                                                                            | 1          | Multisig |
| Denylist Manager   | The denylist manager can add arbitrary EOAs to a denylist, which prevents the address from transferring, minting, or redeeming vault shares. This is similar to Tether and Circle’s denylist, and intended to be used a similar way. Unlike the lvlUSD denylist, there are two separate denylists. The soft denylist prevents addresses from staking, while the full denylist prevents addresses from staking, unstaking, or transferring shares. | Level Foundation                                                                                                            | N < 5      | Multisig |
| Rewarder           | Rewarders can deposit yield from reserves into vaults without creating new shares.                                                                                                                                                                                                                                                                                                                                                                | Level Foundation                                                                                                            | N < 5      | Multisig |
| Freezer (role)     | Freezers can transfer lvlUSD from the vault to a Freezer contract.                                                                                                                                                                                                                                                                                                                                                                                | Level Foundation                                                                                                            | 1          | Multisig |
| Freezer (contract) | The freezer contract stores frozen lvlUSD. Freezer roles can withdraw lvlUSD from the freezer contract back to the vault.                                                                                                                                                                                                                                                                                                                         | Immutable smart contract; addresses that can move funds from and to the freezer contract are controlled by Level Foundation | 1          | Contract |
| Silo               | The silo escrows shares for a user who has initiated a withdrawal. Only the underlying vault can move shares to and from the silo.                                                                                                                                                                                                                                                                                                                | Immutable smart contract with no external roles                                                                             | 1          | Contract |

### Functions

| Functionality                         | Description                                                                                                                                                                                                                                                                                                                                   | Access Control | Multisig |
| ------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- | -------- |
| deposit()                             | The user will send lvlUSD into the vault and mint shares of the vault.                                                                                                                                                                                                                                                                        | Anyone         | Multisig |
| cooldownShares() / cooldownAssets()   | Initiates the cooldown period. The vault will transfer the caller’s shares to the silo contract where it will be escrowed during the cooldown period. If a user has an existing withdrawal request, any new withdrawal request will restart the cooldown period.                                                                              | Anyone         | Contract |
| unstake()                             | Completes the unstaking process. The vault will transfer the caller’s shares back to the caller, calculate the amount of lvlUSD to transfer back to the caller, and simultaneously burn the shares and transfer the user’s stake.                                                                                                             | Anyone         | Contract |
| freeze()                              | Transfers lvlUSD in the vault to the Freezer contract, preventing that amount from being withdrawn. This process does not affect the number of shares outstanding.                                                                                                                                                                            | Freezer        |          |
| transferInFrozenFunds()               | Transfers lvlUSD in the Freezer contract back to the vault. Unfrozen lvlUSD vests over an 8 hour period, which prevents sandwich attacks from happening. This process does not affect the number of shares outstanding.                                                                                                                       | Freezer        |          |
| transferInRewards()                   | Transfers lvlUSD from the protocol’s reserves into the vault. Rewards also vest over an 8 hour period to prevent sandwich attacks. This does not affect the number of shares outstanding.                                                                                                                                                     | Rewarder         |          |
| addToDenylist()/ removeFromDenylist() | Lets the admin denylist an address. If the address is added to the soft denylist, they can do everything but stake new lvlUSD; if address is added to the hard denylist, the address will not be able to stake, unstake, or transfer shares. Addresses that are hard denylisted will likely have their shares redistributed to a new address. | Admin          |          |

## slvlUSDSilo

`slvlUSDSilo` stores `slvlUSD` during the unstaking cooldown period.
